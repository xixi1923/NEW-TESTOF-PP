<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cambodia Scholarship Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .chat-container {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 70vh;
      max-height: 90vh;
    }
    .chat-header {
      background-color: #4f46e5;
      color: white;
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      border-top-left-radius: 1.5rem;
      border-top-right-radius: 1.5rem;
    }
    .chat-messages {
      flex-grow: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }
    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      white-space: pre-line;
      position: relative;
    }
    .message.user {
      background-color: #e0e7ff;
      align-self: flex-end;
      border-bottom-right-radius: 0.25rem;
    }
    .message.bot {
      background-color: #f3f4f6;
      align-self: flex-start;
      border-bottom-left-radius: 0.25rem;
    }
    .chat-input-container {
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .chat-input {
      flex-grow: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      outline: none;
      font-size: 1rem;
    }
    .chat-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    .send-button {
      background-color: #4f46e5;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      border: none;
    }
    .send-button:hover {
      background-color: #4338ca;
    }
    .clear-button {
      background-color: #e5e7eb;
      color: #4f46e5;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-left: 0.5rem;
      transition: background-color 0.2s;
    }
    .clear-button:hover {
      background-color: #c7d2fe;
    }
    .loading-indicator {
      align-self: flex-start;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      background-color: #f3f4f6;
      color: #6b7280;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #a5b4fc;
      border-radius: 50%;
      margin-right: 2px;
      animation: blink 1.2s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .suggestion-btn {
      background: #e0e7ff;
      color: #4f46e5;
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-btn:hover {
      background: #c7d2fe;
    }
    .error-message {
      color: #dc2626;
      font-size: 0.95rem;
      margin-top: 0.5rem;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">Scholarship Bot (Cambodia)</div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="user-input" class="chat-input" placeholder="Type your message..." autocomplete="off" />
      <button id="send-button" class="send-button">Send</button>
      <button id="clear-button" class="clear-button">Clear</button>
    </div>
  </div>
  <script>
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const clearButton = document.getElementById('clear-button');
    const chatMessages = document.getElementById('chat-messages');

    // Scholarship data
    const scholarshipsData = [
      {
        name: "Australia Awards Scholarship",
        university: "Various Australian Universities",
        field_of_study: "All fields, strong encouragement for climate-related study",
        eligibility: "Cambodian citizen, 2 years residency in Cambodia, 2 years full-time work experience, Bachelor's degree for Masters, Master's degree for Doctoral. Encourages women, people with disability, rural residents, ethnic minorities, LGBTQIA+.",
        deadline: "April 30, 2025",
        type: "Postgraduate (Masters, PhD)",
        benefits: "Return air travel, establishment payment, full tuition, living costs, preparatory program, English language training."
      },
      {
        name: "Chevening Scholarship",
        university: "Various UK Universities",
        field_of_study: "Any subject",
        eligibility: "Cambodian citizen, leadership potential, at least two years' work experience, meet academic requirements, English language proficiency.",
        deadline: "October 7, 2025",
        type: "Postgraduate (One-year Master's)",
        benefits: "University tuition fees, monthly stipend, travel costs, arrival allowance, homeward departure allowance, visa application cost, travel grant for Chevening events."
      },
      {
        name: "JDS Scholarship (Japan)",
        university: "Various Japanese Universities",
        field_of_study: "Industrial Development, Agriculture and Rural Development, Better Quality of Life, Strengthening of Governance",
        eligibility: "Cambodian civil servant, 2-year full-time work experience in Target Organization, Bachelor's degree, age 22-39.",
        deadline: "November 19, 2024",
        type: "Postgraduate (Masters)",
        benefits: "Fully funded, includes tuition, living expenses, airfare."
      },
      {
        name: "Maybank Scholarship Programme",
        university: "Royal University of Phnom Penh (RUPP), Royal University of Law and Economics (RULE), National University of Management (NUM), etc.",
        field_of_study: "Business and Future Ready-related courses",
        eligibility: "Cambodian national, total gross household income not more than USD25,000/year, currently enrolled in 1st year undergraduate studies at selected local universities, minimum GPA of 3.0, not more than 21 years of age.",
        deadline: "April 28, 2025",
        type: "Undergraduate",
        benefits: "Full tuition and enrolment fees, laptop, books allowances, insurance, living allowances, internship, employment opportunities after graduation."
      },
      {
        name: "UYFC Scholarship (AUPP)",
        university: "American University of Phnom Penh (AUPP)",
        field_of_study: "Business, International Relations and Diplomacy, Law, Cybersecurity, Digital Infrastructure, Artificial Intelligence",
        eligibility: "High school diploma (BACII A, B, or C), pass AUPP English/Math/Physics/History test, priority for low-income individuals.",
        deadline: "November 13, 2024",
        type: "Undergraduate (Single Degree Programs)",
        benefits: "Full scholarship (requires $310 administrative fee per year)."
      },
      {
        name: "UWCSEA Scholarship (Singapore)",
        university: "UWCSEA (East/Dover) campuses in Singapore",
        field_of_study: "General academic program",
        eligibility: "Cambodian citizen residing in Cambodia, age 13-15, sufficient English skills, critical thinking, academic potential, community involvement, aligned with UWC values.",
        deadline: "Typically around May-July for applications",
        type: "Secondary/Pre-university (5-Year Programme)",
        benefits: "Fully funded (subject to family contribution review), covers educational and accommodation fees, meals, travel, small living allowance."
      }
    ];

    // Session context
    let chatHistory = [];

    // Welcome message and suggestions
    function welcomeMessage() {
      displayMessage("ðŸ‘‹ Hello! I'm your Scholarship Bot. I can provide information about scholarships in Cambodia. What would you like to know?", "bot");
      displaySuggestions();
    }

    function displaySuggestions() {
      const suggestions = [
        "Show me all scholarships for undergraduate.",
        "What are the eligibility criteria for Australia Awards?",
        "List scholarships for business field.",
        "Deadlines for scholarships in 2025?",
        "Which scholarships are fully funded?"
      ];
      const suggestionWrap = document.createElement('div');
      suggestionWrap.className = "message bot";
      const label = document.createElement('div');
      label.innerHTML = "<strong>Quick questions:</strong>";
      suggestionWrap.appendChild(label);

      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = "suggestions";
      suggestions.forEach(q => {
        const btn = document.createElement('button');
        btn.textContent = q;
        btn.className = "suggestion-btn";
        btn.onclick = () => {
          userInput.value = q;
          processUserInput();
        };
        suggestionsDiv.appendChild(btn);
      });
      suggestionWrap.appendChild(suggestionsDiv);
      chatMessages.appendChild(suggestionWrap);
      smoothScrollToBottom();
    }

    // Display message
    function displayMessage(message, sender) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', sender);
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      smoothScrollToBottom();
    }

    // Display error message
    function displayError(message) {
      const errorElement = document.createElement('div');
      errorElement.className = 'error-message';
      errorElement.textContent = message;
      chatMessages.appendChild(errorElement);
      smoothScrollToBottom();
    }

    // Loading animation
    function showLoading() {
      const loadingElement = document.createElement('div');
      loadingElement.classList.add('loading-indicator');
      loadingElement.id = 'loading-indicator';
      loadingElement.innerHTML = 'Bot is typing <span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chatMessages.appendChild(loadingElement);
      smoothScrollToBottom();
    }

    function hideLoading() {
      const loadingElement = document.getElementById('loading-indicator');
      if (loadingElement) loadingElement.remove();
    }

    // Smooth scroll
    function smoothScrollToBottom() {
      chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: "smooth" });
    }

    // Reset chat
    function resetChat() {
      chatMessages.innerHTML = '';
      chatHistory = [];
      userInput.value = '';
      userInput.focus();
      welcomeMessage();
    }

    // Gemini API call with session context
    async function getGeminiResponse(prompt) {
      // Compose session context for Gemini
      const history = chatHistory.map(msg => ({
        role: msg.sender === "user" ? "user" : "model",
        parts: [{ text: msg.text }]
      }));
      history.push({ role: "user", parts: [{ text: prompt }] });

      const payload = {
        contents: history,
        generationConfig: { responseMimeType: "text/plain" }
      };

      const apiKey = "AIzaSyA0wgstSIvpJeGYg9FM74_r8Ole6GcgNHc";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (
          result.candidates &&
          result.candidates.length > 0 &&
          result.candidates[0].content &&
          result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0
        ) {
          return result.candidates[0].content.parts[0].text;
        } else {
          return "Sorry, I couldn't generate a response. Please try again.";
        }
      } catch (error) {
        return "Sorry, I'm having trouble connecting right now. Please try again later.";
      }
    }

    // Process user input
    async function processUserInput() {
      const userText = userInput.value.trim();
      if (userText === '' || sendButton.disabled) return;

      displayMessage(userText, 'user');
      chatHistory.push({ sender: "user", text: userText });
      userInput.value = '';
      sendButton.disabled = true;
      userInput.disabled = true;
      showLoading();

      // Format scholarship data for prompt
      const scholarshipInfo = scholarshipsData
        .map(s =>
          `Name: ${s.name}
University: ${s.university}
Field: ${s.field_of_study}
Eligibility: ${s.eligibility}
Deadline: ${s.deadline}
Type: ${s.type}
Benefits: ${s.benefits}`)
        .join('\n\n---\n\n');

      // UPDATED PROMPT: Instruct bot not to use asterisk (*) if it doesn't have info
      const prompt = `
You are a helpful chatbot providing information about scholarships in Cambodia.

Here is the list of scholarships I can help with:

${scholarshipInfo}

Based on the user's question below, answer clearly and concisely using only the information above. 
If you don't know the answer, say you don't have that information. Do not use an asterisk (*) in your reply.

User question: ${userText}
`;

      let botResponse = await getGeminiResponse(prompt);
      hideLoading();

      if (!botResponse || botResponse.trim() === '') {
        displayError("Sorry, I couldn't generate a response. Please try again.");
      } else {
        displayMessage(botResponse.trim(), 'bot');
        chatHistory.push({ sender: "bot", text: botResponse.trim() });
      }

      sendButton.disabled = false;
      userInput.disabled = false;
      userInput.focus();
    }

    // Event listeners
    sendButton.addEventListener('click', processUserInput);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') processUserInput();
    });
    clearButton.addEventListener('click', resetChat);
    
    // Autofocus input on load
    window.onload = () => {
      userInput.focus();
      welcomeMessage();
    };
  </script>
</body>
</html>